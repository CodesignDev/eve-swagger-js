<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>internal.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-alliance.html">alliance</a><ul class='methods'><li data-type='method'><a href="module-alliance.html#.get">get</a></li><li data-type='method'><a href="module-alliance.html#.getAll">getAll</a></li><li data-type='method'><a href="module-alliance.html#.getCorporations">getCorporations</a></li><li data-type='method'><a href="module-alliance.html#.getIcons">getIcons</a></li><li data-type='method'><a href="module-alliance.html#.getNamesOf">getNamesOf</a></li></ul></li><li><a href="module-character.html">character</a><ul class='members'><li data-type='member'><a href="module-character.html#.calendar">calendar</a></li><li data-type='member'><a href="module-character.html#.fittings">fittings</a></li><li data-type='member'><a href="module-character.html#.mail">mail</a></li></ul><ul class='methods'><li data-type='method'><a href="module-character.html#.get">get</a></li><li data-type='method'><a href="module-character.html#.getAssets">getAssets</a></li><li data-type='method'><a href="module-character.html#.getBookmarkFolders">getBookmarkFolders</a></li><li data-type='method'><a href="module-character.html#.getBookmarks">getBookmarks</a></li><li data-type='method'><a href="module-character.html#.getClones">getClones</a></li><li data-type='method'><a href="module-character.html#.getColonies">getColonies</a></li><li data-type='method'><a href="module-character.html#.getColonyLayout">getColonyLayout</a></li><li data-type='method'><a href="module-character.html#.getCorporationHistory">getCorporationHistory</a></li><li data-type='method'><a href="module-character.html#.getKillmails">getKillmails</a></li><li data-type='method'><a href="module-character.html#.getLocation">getLocation</a></li><li data-type='method'><a href="module-character.html#.getNamesOf">getNamesOf</a></li><li data-type='method'><a href="module-character.html#.getPortraits">getPortraits</a></li><li data-type='method'><a href="module-character.html#.getShip">getShip</a></li><li data-type='method'><a href="module-character.html#.getSkillQueue">getSkillQueue</a></li><li data-type='method'><a href="module-character.html#.getSkills">getSkills</a></li><li data-type='method'><a href="module-character.html#.getWallets">getWallets</a></li></ul></li><li><a href="module-character_calendar.html">character/calendar</a><ul class='methods'><li data-type='method'><a href="module-character_calendar.html#.get">get</a></li><li data-type='method'><a href="module-character_calendar.html#.getEvent">getEvent</a></li><li data-type='method'><a href="module-character_calendar.html#.updateResponse">updateResponse</a></li></ul></li><li><a href="module-character_contacts.html">character/contacts</a><ul class='methods'><li data-type='method'><a href="module-character_contacts.html#.add">add</a></li><li data-type='method'><a href="module-character_contacts.html#.addWatched">addWatched</a></li><li data-type='method'><a href="module-character_contacts.html#.get">get</a></li><li data-type='method'><a href="module-character_contacts.html#.getLabels">getLabels</a></li><li data-type='method'><a href="module-character_contacts.html#.remove">remove</a></li><li data-type='method'><a href="module-character_contacts.html#.update">update</a></li><li data-type='method'><a href="module-character_contacts.html#.updateWatched">updateWatched</a></li></ul></li><li><a href="module-character_fittings.html">character/fittings</a><ul class='methods'><li data-type='method'><a href="module-character_fittings.html#.add">add</a></li><li data-type='method'><a href="module-character_fittings.html#.getAll">getAll</a></li><li data-type='method'><a href="module-character_fittings.html#.remove">remove</a></li></ul></li><li><a href="module-character_mail.html">character/mail</a><ul class='methods'><li data-type='method'><a href="module-character_mail.html#.addInboxLabel">addInboxLabel</a></li><li data-type='method'><a href="module-character_mail.html#.delete">delete</a></li><li data-type='method'><a href="module-character_mail.html#.get">get</a></li><li data-type='method'><a href="module-character_mail.html#.getCSPACost">getCSPACost</a></li><li data-type='method'><a href="module-character_mail.html#.getInbox">getInbox</a></li><li data-type='method'><a href="module-character_mail.html#.getInboxLabels">getInboxLabels</a></li><li data-type='method'><a href="module-character_mail.html#.getMailingLists">getMailingLists</a></li><li data-type='method'><a href="module-character_mail.html#.removeInboxLabel">removeInboxLabel</a></li><li data-type='method'><a href="module-character_mail.html#.send">send</a></li><li data-type='method'><a href="module-character_mail.html#.update">update</a></li></ul></li><li><a href="module-corporation.html">corporation</a><ul class='methods'><li data-type='method'><a href="module-corporation.html#.get">get</a></li><li data-type='method'><a href="module-corporation.html#.getAllianceHistory">getAllianceHistory</a></li><li data-type='method'><a href="module-corporation.html#.getIcons">getIcons</a></li><li data-type='method'><a href="module-corporation.html#.getMembers">getMembers</a></li><li data-type='method'><a href="module-corporation.html#.getNamesOf">getNamesOf</a></li><li data-type='method'><a href="module-corporation.html#.getRoles">getRoles</a></li></ul></li><li><a href="module-eve_swagger_interface.html">eve_swagger_interface</a><ul class='members'><li data-type='member'><a href="module-eve_swagger_interface.html#.alliance">alliance</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.character">character</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.corporation">corporation</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.fleets">fleets</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.incursions">incursions</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.industry">industry</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.insurance">insurance</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.killmails">killmails</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.languages">languages</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.market">market</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.search">search</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.sovereignty">sovereignty</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.ui">ui</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.universe">universe</a></li><li data-type='member'><a href="module-eve_swagger_interface.html#.wars">wars</a></li></ul></li><li><a href="module-fleets.html">fleets</a><ul class='methods'><li data-type='method'><a href="module-fleets.html#.addSquad">addSquad</a></li><li data-type='method'><a href="module-fleets.html#.addWing">addWing</a></li><li data-type='method'><a href="module-fleets.html#.get">get</a></li><li data-type='method'><a href="module-fleets.html#.getMembers">getMembers</a></li><li data-type='method'><a href="module-fleets.html#.getWings">getWings</a></li><li data-type='method'><a href="module-fleets.html#.inviteMember">inviteMember</a></li><li data-type='method'><a href="module-fleets.html#.kickMember">kickMember</a></li><li data-type='method'><a href="module-fleets.html#.removeSquad">removeSquad</a></li><li data-type='method'><a href="module-fleets.html#.removeWing">removeWing</a></li><li data-type='method'><a href="module-fleets.html#.update">update</a></li><li data-type='method'><a href="module-fleets.html#.updateMember">updateMember</a></li><li data-type='method'><a href="module-fleets.html#.updateSquad">updateSquad</a></li><li data-type='method'><a href="module-fleets.html#.updateWing">updateWing</a></li></ul></li><li><a href="module-incursions.html">incursions</a><ul class='methods'><li data-type='method'><a href="module-incursions.html#.getAll">getAll</a></li></ul></li><li><a href="module-industry.html">industry</a><ul class='methods'><li data-type='method'><a href="module-industry.html#.getFacilities">getFacilities</a></li><li data-type='method'><a href="module-industry.html#.getSystemCostIndices">getSystemCostIndices</a></li></ul></li><li><a href="module-insurance.html">insurance</a><ul class='methods'><li data-type='method'><a href="module-insurance.html#.getPrices">getPrices</a></li></ul></li><li><a href="module-killmails.html">killmails</a><ul class='methods'><li data-type='method'><a href="module-killmails.html#.get">get</a></li></ul></li><li><a href="module-market.html">market</a><ul class='methods'><li data-type='method'><a href="module-market.html#.getBuyOrdersFor">getBuyOrdersFor</a></li><li data-type='method'><a href="module-market.html#.getHistory">getHistory</a></li><li data-type='method'><a href="module-market.html#.getOrders">getOrders</a></li><li data-type='method'><a href="module-market.html#.getOrdersFor">getOrdersFor</a></li><li data-type='method'><a href="module-market.html#.getPrices">getPrices</a></li><li data-type='method'><a href="module-market.html#.getSellOrdersFor">getSellOrdersFor</a></li><li data-type='method'><a href="module-market.html#.getStructureOrders">getStructureOrders</a></li></ul></li><li><a href="module-search.html">search</a><ul class='members'><li data-type='member'><a href="module-search.html#.categories">categories</a></li><li data-type='member'><a href="module-search.html#.strict">strict</a></li></ul><ul class='methods'><li data-type='method'><a href="module-search.html#.forCharacter">forCharacter</a></li><li data-type='method'><a href="module-search.html#.get">get</a></li><li data-type='method'><a href="module-search.html#.getAgents">getAgents</a></li><li data-type='method'><a href="module-search.html#.getAlliances">getAlliances</a></li><li data-type='method'><a href="module-search.html#.getCharacters">getCharacters</a></li><li data-type='method'><a href="module-search.html#.getConstellations">getConstellations</a></li><li data-type='method'><a href="module-search.html#.getCorporations">getCorporations</a></li><li data-type='method'><a href="module-search.html#.getFactions">getFactions</a></li><li data-type='method'><a href="module-search.html#.getInventoryTypes">getInventoryTypes</a></li><li data-type='method'><a href="module-search.html#.getRegions">getRegions</a></li><li data-type='method'><a href="module-search.html#.getSolarSystems">getSolarSystems</a></li><li data-type='method'><a href="module-search.html#.getStations">getStations</a></li><li data-type='method'><a href="module-search.html#.getWormholes">getWormholes</a></li></ul></li><li><a href="module-sovereignty.html">sovereignty</a><ul class='methods'><li data-type='method'><a href="module-sovereignty.html#.getCampaigns">getCampaigns</a></li><li data-type='method'><a href="module-sovereignty.html#.getCampaigns">getCampaigns</a></li></ul></li><li><a href="module-ui.html">ui</a><ul class='methods'><li data-type='method'><a href="module-ui.html#.appendWaypoint">appendWaypoint</a></li><li data-type='method'><a href="module-ui.html#.openContract">openContract</a></li><li data-type='method'><a href="module-ui.html#.openInfo">openInfo</a></li><li data-type='method'><a href="module-ui.html#.openMarket">openMarket</a></li><li data-type='method'><a href="module-ui.html#.openNewMail">openNewMail</a></li><li data-type='method'><a href="module-ui.html#.prependWaypoint">prependWaypoint</a></li><li data-type='method'><a href="module-ui.html#.setWaypoint">setWaypoint</a></li></ul></li><li><a href="module-universe.html">universe</a><ul class='methods'><li data-type='method'><a href="module-universe.html#.getCategories">getCategories</a></li><li data-type='method'><a href="module-universe.html#.getCategory">getCategory</a></li><li data-type='method'><a href="module-universe.html#.getGroup">getGroup</a></li><li data-type='method'><a href="module-universe.html#.getGroups">getGroups</a></li><li data-type='method'><a href="module-universe.html#.getNamesOf">getNamesOf</a></li><li data-type='method'><a href="module-universe.html#.getSchematic">getSchematic</a></li><li data-type='method'><a href="module-universe.html#.getStation">getStation</a></li><li data-type='method'><a href="module-universe.html#.getStructure">getStructure</a></li><li data-type='method'><a href="module-universe.html#.getStructures">getStructures</a></li><li data-type='method'><a href="module-universe.html#.getSystem">getSystem</a></li><li data-type='method'><a href="module-universe.html#.getType">getType</a></li></ul></li><li><a href="module-wars.html">wars</a><ul class='methods'><li data-type='method'><a href="module-wars.html#.get">get</a></li><li data-type='method'><a href="module-wars.html#.getKillmails">getKillmails</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Promise.html">Promise</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">internal.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Internal code to handle caching and promisification of generated ESI client.
 * @module internal
 * @private
 */

/**
 * A Bluebird JS Promise.
 * @external Promise
 * @see http://bluebirdjs.com
 */

const Promise = require('bluebird');
const Moment = require('moment');
const Cache = require('node-cache');
const ESI = require('../generated/src');

module.exports = function(opts) {
  var cache = new Cache({ useClones: false });
  var defaultBaseURL = 'https://esi.tech.ccp.is/latest';

  opts = opts || {};
  if (opts.datasource === undefined) {
    opts.datasource = 'tranquility';
  }
  if (opts.language === undefined) {
    opts.language = 'en';
  }
  if (opts.baseURL === undefined) {
    opts.baseURL = defaultBaseURL;
  }
  if (opts.accessToken === undefined) {
    opts.accessToken = null;
  }

  var exports = {};

  /**
   * The options provided to the factory function.
   */
  exports.opts = opts;

  /**
   * The swagger-codegen ESI module.
   */
  exports.esi = ESI;

  /**
   * Create a new ESI Api instance based on the given Ctor. If `accessToken` is
   * not undefined, the new Api is also created with a new ApiClient instance
   * configured to use 'evesso' authentication with the given token.
   *
   * A new Api must be created for each request since the authentications data
   * is otherwise persistent, resulting in race conditions when multiple
   * requests need to be made with different tokens.
   *
   * @param {Constructor} apiCtor One of the ESI.xyzApi constructor functions
   * @param {String} accessToken Optional Eve SSO access token for
   *   authentication
   * @return A new Api instance
   */
  var newApi = function(apiCtor, accessToken) {
    var api;
    accessToken = accessToken || opts.accessToken;
    if (accessToken) {
      api = new apiCtor(new ESI.ApiClient());
      api.apiClient.authentications['evesso'].accessToken = accessToken;
    } else {
      api = new apiCtor();
    }

    // Hack in a new baseURL, which is hardcoded in the swagger-codegen lib
    if (opts.baseURL != defaultBaseURL) {
      api.apiClient.basePath = opts.baseURL.replace(/\/+$/, '');
    }
    return api;
  };

  /**
   * Create a new object holding the default options/parameters for an ESI
   * request. Currently this configures the data source to tranquility and sets
   * the default accept language.
   *
   * @return {Object} The default options
   */
  var defaultOpts = function() {
    return {
      'datasource': opts.datasource,
      'language': opts.language
    };
  };

  /**
   * Invoke the function, `functionName`, on an Api instance to be created by
   * `apiCtor` if an http request must actually be made. The function will be
   * invoked with `args`, which must be an array of arguments as you'd pass to
   * `Function.apply()`. If `accessToken` is not undefined it will be used as
   * the EVE SSO token for authentication.
   *
   * This will cache data and error responses, where the cache time is based on
   * the "expires" header in the http response.
   *
   * `resolve` and `reject` must be Promise handler functions, as provided by
   * the Promise constructor.
   *
   * @param {Constructor} apiCtor One of the ESI.xyzApi constructor functions
   * @param {String} functionName The name of a function callable on the
   *   Api instance created by `apiCtor`.
   * @param {Array} args Array of arguments to pass to ESI Api function call
   * @param {Object} opts Optional parameter object to pass to the ESI call
   * @param {String} accessToken Optional access token to use for
   *   authentication, pass `undefined` if not needed
   * @param {Function} resolve Promise resolve handler
   * @param {Function} reject Promise error resolution handler
   */
  var getCachedRequest = function(apiCtor, functionName, args, opts,
      accessToken, resolve, reject) {
    // Make options not null
    opts = opts || {};

    var _this = this;
    var key = functionName + '/' + JSON.stringify(args) + '+' + JSON.stringify(
            opts);
    if (accessToken) {
      key = key + '@' + accessToken;
    }

    var blob = cache.get(key);
    if (blob == undefined) {
      // Request isn't cached any more, so must make the request anew

      // Append the ESI callback function to the arguments array
      var fullArgs = args.slice(0);
      fullArgs.push(Object.assign(defaultOpts(), opts));
      fullArgs.push(function(error, data, response) {
        // Look up all collected resolve/reject handlers in the cache
        var toNotify = cache.get(key);
        try {
          // Set state of cache to received data before resolving
          // promises, with a timeout based on expires header.
          var timeout = 0;
          if (response.header.expires) {
            var expires = Moment.utc(response.header.expires,
                'ddd, DD MMM YYYY HH:mm:ss GMT');
            timeout = expires.diff(Moment.utc([]), 'seconds', true);
          }

          if (error) {
            cache.set(key, { error: error.response.error }, timeout);
            for (r in toNotify.onReject) {
              toNotify.onReject[r].apply(_this, [error.response.error]);
            }
          } else {
            // Make sure data isn't null
            data = data || {};
            cache.set(key, { data: data }, timeout);
            for (r in toNotify.onResolve) {
              toNotify.onResolve[r].apply(_this, [data]);
            }
          }
        } catch (e) {
          // Push the exception caught in the ESI callback to all the
          // registered rejects.
          if (toNotify &amp;&amp; toNotify.onReject) {
            for (r in toNotify.onReject) {
              toNotify.onReject[r].apply(_this, e);
            }
          } else {
            // In this worst case scenario, at least notify the
            // reject handler that was provided initially (will not
            // reject any subsequently cached handlers but that
            // shouldn't happen).
            reject.apply(_this, e);
          }
        }
      });
      // Invoke ESI function
      var api = newApi(apiCtor, accessToken);
      api[functionName].apply(api, fullArgs);

      // Set in cache after API call, in the event that the API function
      // fails on validation before it gets to the point where it handles
      // the callback which would notify the resolve/reject listeners.
      // - No timeout yet so that this won't expire until ESI request
      //   is completed or times-out on its own
      cache.set(key, {
        onResolve: [resolve],
        onReject: [reject]
      });
    } else if (blob.data) {
      // A previous request has completed successfully, so just invoke
      // the provided resolve.
      resolve.apply(_this, [blob.data]);
    } else if (blob.error) {
      // A previous request has completed with an error, so just invoke
      // the provided reject.
      reject.apply(_this, [blob.error]);
    } else {
      // A prior equivalent request has been initiated but hasn't
      // completed, so append the promise handlers to the cache blob.
      blob.onResolve.push(resolve);
      blob.onReject.push(reject);
    }
  };

  /**
   * Create a new Promise for invoking the ESI request described by the Api
   * constructor, `apiCtor`, the function `functionName`, and arguments stored
   * in the array, `args`. If `accessToken` is defined then it will be used for
   * SSO authentication.
   *
   * @param {Constructor} apiCtor One of the ESI.xyzApi constructor functions
   * @param {String} functionName The name of a function callable on the
   *   Api instance created by `apiCtor`.
   * @param {Array} args Array of arguments to pass to ESI Api function call
   * @param {String} accessToken Optional access token to use for
   *   authentication, pass `undefined` if not needed
   * @return A new promise that resolves to the data returned by the request
   */
  exports.newRequest = function(apiCtor, functionName, args, accessToken) {
    return new Promise(function(resolve, reject) {
      getCachedRequest.apply(this, [
        apiCtor, functionName, args, null, accessToken, resolve, reject
      ]);
    });
  };

  /**
   * Create a new Promise for invoking the ESI request described by the Api
   * constructor, `apiCtor`, the function `functionName`, and arguments stored
   * in the array, `args`. If `accessToken` is defined then it will be used for
   * SSO authentication. The `opts` argument is presumed to be an object
   * suitable for the API request, and will be modified to include additional
   * default properties configured by the factory.
   *
   * @param {Constructor} apiCtor One of the ESI.xyzApi constructor functions
   * @param {String} functionName The name of a function callable on the
   *   Api instance created by `apiCtor`.
   * @param {Array} args Array of arguments to pass to ESI Api function call
   * @param {Object} opts Optional parameters object to pass to the ESI call
   * @param {String} accessToken Optional access token to use for
   *   authentication, pass `undefined` if not needed
   * @return A new promise that resolves to the data returned by the request
   */
  exports.newRequestOpt = function(apiCtor, functionName, args, opts,
      accessToken) {
    return new Promise(function(resolve, reject) {
      getCachedRequest.apply(this, [
        apiCtor, functionName, args, opts, accessToken, resolve, reject
      ]);
    });
  };

  return exports;
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Jan 22 2017 13:27:01 GMT-0600 (CST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
